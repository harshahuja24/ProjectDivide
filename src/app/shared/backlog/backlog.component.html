<div class="backlog-container">
  <div class="header-section">
    <h1>Backlog</h1>
    <div class="header-actions">
      <div class="search-box">
        <input type="text" placeholder="Search issues..." class="form-control">
      </div>
      <button class="btn btn-primary" (click)="createSprint()" (click)="isTaskModalOpen = true">
        <i class="fas fa-plus"></i>
        Create Sprint
      </button>
    </div>
  </div>

  <div class="sprint-container" *ngFor="let sprint of allSprints; let i = index">
    <div class="sprint-header" (click)="toggleSprint(i)" [class.expanded]="sprintExpanded[i]">
      <div class="sprint-toggle">
        <i class="fas" [class.fa-chevron-right]="!sprintExpanded[i]" [class.fa-chevron-down]="sprintExpanded[i]"></i>
      </div>
      
      <div class="sprint-info">
        <div class="sprint-title-row">
          <h4 class="sprint-title">{{ sprint.sprintTitle }}</h4>
          <div class="sprint-status-badge" [ngClass]="{'active': sprint.activeYN, 'inactive': !sprint.activeYN}">
            <span class="status-dot" [ngClass]="{'active': sprint.activeYN, 'inactive': !sprint.activeYN}"></span>
            {{ sprint.activeYN ? 'Active' : 'Inactive' }}
          </div>
        </div>
        
        <div class="sprint-meta">
          <span class="sprint-dates">
            <i class="fas fa-calendar-alt"></i>
            {{ sprint.startDate | date:'MMM d, yyyy' }} - {{ sprint.endDate | date:'MMM d, yyyy' }}
          </span>
          <span class="sprint-duration">{{ getDuration(sprint.startDate, sprint.endDate) }} days</span>
        </div>
        
        <div class="sprint-stats" *ngIf="!sprintExpanded[i]">
          <span class="stat-item">
            <i class="fas fa-tasks"></i>
            {{ sprint.taskList.length }} issues
          </span>
          <span class="stat-item">
            <i class="fas fa-check-circle"></i>
            {{ getCompletedTasks(sprint.taskList) }} completed
          </span>
        </div>
      </div>

      <div class="sprint-actions" (click)="$event.stopPropagation()">
        <button class="btn-action btn-start" title="Start Sprint" (click)="startSprint(sprint.sprintId)">
          <i class="fas fa-play"></i>
        </button>
        <button class="btn-action btn-menu" title="More actions">
          <i class="fas fa-ellipsis-h"></i>
        </button>
      </div>
    </div>

    <div class="sprint-content" [class.expanded]="sprintExpanded[i]" *ngIf="sprintExpanded[i]">
      <div class="sprint-description" *ngIf="sprint.sprintDesc" [innerHTML]="sprint.sprintDesc"></div>
      
      <div class="sprint-detailed-stats">
        <div class="stat-card">
          <div class="stat-value">{{ sprint.taskList.length }}</div>
          <div class="stat-label">Total Issues</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ getCompletedTasks(sprint.taskList) }}</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ sprint.taskList.length - getCompletedTasks(sprint.taskList) }}</div>
          <div class="stat-label">Remaining</div>
        </div>
      </div>

      <div class="sprint-tasks">
        <div class="tasks-header">
          <h6>Issues in Sprint</h6>
          <button class="btn-create-issue" title="Create Issue">
            <i class="fas fa-plus"></i>
            Create Issue
          </button>
        </div>

        <div class="task-list">
          <div *ngFor="let task of sprint.taskList" class="task-item" [class.completed]="task.taskStatus === 'DONE'">
            <div class="task-type-indicator">
              <i class="fas fa-bookmark task-type-icon"></i>
            </div>
            
            <div class="task-content">
              <div class="task-header">
                <span class="task-key">{{ sprint.sprintTitle.split(' ')[0] }}-{{ task.taskId }}</span>
                <span class="task-title">{{ task.taskTitle }}</span>
              </div>
              
              <div class="task-description" *ngIf="task.taskDesc">
                {{ task.taskDesc }}
              </div>
              
              <div class="task-meta">
                <div class="task-dates">
                  <span class="created-date">Created {{ task.createdAt | date:'MMM d, yyyy' }}</span>
                  <span class="updated-date">Updated {{ task.createdAt | date:'h:mm a' }}</span>
                </div>
              </div>
            </div>

            <div class="task-right">
              <div class="task-status">
                <span class="status-badge" [class]="getStatusClass(task.taskStatus)">
                  {{ task.taskStatus }}
                </span>
              </div>
              
              <div class="task-assignee">
                <div class="avatar-circle" [title]="'Assigned to User ' + task.assignedTo">
                  {{ getInitials(task.assignedTo) }}
                </div>
              </div>
              
              <div class="task-actions">
                <button class="btn-icon" (click)="editTask(task.taskId)" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon btn-danger" (click)="deleteTask(task.taskId)" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div *ngIf="sprint.taskList.length === 0" class="empty-state">
          <div class="empty-icon">
            <i class="fas fa-clipboard-list"></i>
          </div>
          <h6>No issues in this sprint</h6>
          <p>Create your first issue to get started</p>
          <button class="btn-create-issue">
            <i class="fas fa-plus"></i>
            Create Issue
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="backlog-section">
    <div class="backlog-header">
      <div class="backlog-title">
        <h5>Backlog</h5>
        <span class="issue-count">{{ backlogTasks.length || 0 }} issues</span>
      </div>
    </div>

    <div class="backlog-content">
      <div *ngFor="let task of backlogTasks" class="backlog-item">
        <div class="task-type-indicator">
          <i class="fas fa-bookmark task-type-icon"></i>
        </div>
        
        <div class="task-content">
          <div class="task-header">
            <span class="task-key">{{ task.id }}</span>
            <span class="task-title">{{ task.title }}</span>
          </div>
        </div>

        <div class="task-right">
          <div class="task-status">
            <span class="status-badge" [class]="getStatusClass(task.status)">
              {{ task.status }}
            </span>
          </div>
          
          <div class="task-assignee">
            <div class="avatar-circle" [title]="'Assigned to ' + task.assignee">
              {{ task.assignee }}
            </div>
          </div>
          
          <div class="task-actions">
            <button class="btn-icon btn-danger" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-container" [class.show]="isTaskModalOpen">
  <div class="custom-backdrop"></div>
  <div class="modal fade show d-block" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Sprint</h5>
          <button type="button" class="btn-close" (click)="isTaskModalOpen = false"></button>
        </div>
        <div class="modal-body">
          <form [formGroup]="sprintForm" (ngSubmit)="submitSprint()">
            <div class="row">
              <div class="col-md-5 border-end">
                <div class="mb-3">
                  <label class="form-label">Sprint Title</label>
                  <input type="text" class="form-control" formControlName="sprintTitle" placeholder="Enter Sprint Title">
                </div>
            
                <div class="mb-3">
                  <label class="form-label">Start Date</label>
                  <input type="date" class="form-control" formControlName="startDate">
                </div>

                <div class="mb-3">
                  <label class="form-label">End Date</label>
                  <input type="date" class="form-control" formControlName="endDate">
                </div>
              </div>
              
              <div class="col-md-7">
                <div class="mb-3">
                  <label class="form-label">Sprint Description</label>
                  <angular-editor formControlName="sprintDesc" [config]="config"></angular-editor>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="submit" class="btn btn-success">Submit</button>
              <button type="button" class="btn btn-secondary" (click)="isTaskModalOpen = false">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>